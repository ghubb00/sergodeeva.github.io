<!DOCTYPE html>
<html lang="en-US">

  <head>
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.4.0 -->
<title>Bulk update records in MySQL DB with Python | Natalya Kosenko’s Blog</title>
<meta name="generator" content="Jekyll v3.7.3" />
<meta property="og:title" content="Bulk update records in MySQL DB with Python" />
<meta name="author" content="Natalya Kosenko" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Using INSERT ON DUPLICATE KEY UPDATE" />
<meta property="og:description" content="Using INSERT ON DUPLICATE KEY UPDATE" />
<link rel="canonical" href="http://localhost:4000/2018-06-02-bulk-update-records-in-mysql-db-with-python" />
<meta property="og:url" content="http://localhost:4000/2018-06-02-bulk-update-records-in-mysql-db-with-python" />
<meta property="og:site_name" content="Natalya Kosenko’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-06-02T12:19:00+08:00" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2018-06-02-bulk-update-records-in-mysql-db-with-python","author":{"@type":"Person","name":"Natalya Kosenko"},"description":"Using INSERT ON DUPLICATE KEY UPDATE","headline":"Bulk update records in MySQL DB with Python","dateModified":"2018-06-02T12:19:00+08:00","datePublished":"2018-06-02T12:19:00+08:00","@type":"BlogPosting","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://www.natalyakosenko.com/assets/logo.png"},"name":"Natalya Kosenko"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2018-06-02-bulk-update-records-in-mysql-db-with-python"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/assets/css/style.css?v=ac7662552453f3a47ffeca9e81f0c8787c7b359f">
  <link rel="shortcut icon" href="/assets/favicon.png">
  <script src="https://use.fontawesome.com/9f9cb26d6f.js"></script>

  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-37473492-7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-37473492-7');
</script>
  

  
    





  

</head>
  <body>
    <div class="nav">
  <a class="logo"></a>
  <ul class="navbar-nav">
    <li><a href="/">Home</a></li>
    <li><a href="/about">About</a></li>
  </ul>
</div>
<section class="page-header">
  
    <h1 class="project-name">Bulk update records in MySQL DB with Python</h1>
    
      <h2 class="project-tagline">Using INSERT ON DUPLICATE KEY UPDATE</h2>
     
  
  
</section>
    <section class="main-content">
      <article class="post">

  <header class="post-header">
    <p class="post-meta">
      <time datetime="2018-06-02T12:19:00+08:00" itemprop="datePublished">
        
        Jun 2, 2018
      </time>
      
      <span>
        
          
          <a href="/tag/python"><code class="highligher-rouge"><nobr>#python</nobr></code></a>
        
          
          <a href="/tag/mysql"><code class="highligher-rouge"><nobr>#mysql</nobr></code></a>
        
      </span>  
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Yesterday I spent a couple of hours trying to find the best way of updating multiple records in MySQL db using Python. Unfortunately could not find any really elegant way, as a result I ended up with using <code class="highlighter-rouge">'INSERT ON DUPLICATE KEY UPDATE'</code>.</p>

<p>Sharing my code here, hope it will save you time. If you know any better way of updating multiple rows in mysql db with python, let me know in the comments.</p>

<p>So, let’s say I have a <code class="highlighter-rouge">students</code> table wich looks like this:</p>

<table>
  <thead>
    <tr>
      <th>id</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>cate blanchett</td>
    </tr>
    <tr>
      <td>2</td>
      <td>sia furler</td>
    </tr>
    <tr>
      <td>3</td>
      <td>priyanka chopra</td>
    </tr>
  </tbody>
</table>

<p>And let’s say I want to capitalize each word in the <code class="highlighter-rouge">name</code> column (in reality I needed to apply more complex transformation, but will be talking about capitalizing for simplicity).</p>

<p>Here is the code that is doing a bulk update:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="n">sql_select</span> <span class="o">=</span> <span class="s">"SELECT id, name FROM students"</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">'mysql+pymysql://root:123@127.0.0.1:3306/schooldb?charset=utf8'</span><span class="p">)</span>

<span class="n">students_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql_select</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
<span class="n">students_df</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">students_df</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
<span class="n">students_tp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">prod</span><span class="p">)</span> <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="n">students_df</span><span class="o">.</span><span class="n">values</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">'[]'</span><span class="p">)</span>

<span class="n">sql_update</span> <span class="o">=</span> <span class="s">"INSERT INTO students (id, name) VALUES "</span> <span class="o">+</span> <span class="n">students_tp</span> <span class="o">+</span> <span class="s">" ON DUPLICATE KEY UPDATE name=VALUES(name)"</span>

<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_update</span><span class="p">)</span></code></pre></figure>

<p>Basically what I am doing here is:</p>
<ul>
  <li>getting data from the DB table using <code class="highlighter-rouge">sqlalchemy</code></li>
  <li>storing it into dataframe (to do so need to import <code class="highlighter-rouge">pandas</code>)</li>
  <li>applying the transformation I need (in this case I am capitalizing each word in the <code class="highlighter-rouge">name</code> column using <code class="highlighter-rouge">title()</code> function)</li>
  <li>converting the transformed dataframe to tuples (so that the data will look like <code class="highlighter-rouge">(1, 'Cate Blanchett'), (2, 'Sia Furler'), (3, 'Priyanka Chopra')</code>)</li>
  <li>updating the table using ‘INSERT INTO’ … ‘ON DUPLICATE KEY UPDATE’ statement</li>
</ul>

<p>This is how the database table looks like after I ran my script:</p>

<table>
  <thead>
    <tr>
      <th>id</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>Cate Blanchett</td>
    </tr>
    <tr>
      <td>2</td>
      <td>Sia Furler</td>
    </tr>
    <tr>
      <td>3</td>
      <td>Priyanka Chopra</td>
    </tr>
  </tbody>
</table>

<p>Easy. But I still feel there should be a better way…</p>

  </div>

  <br/>
  <iframe src="https://www.facebook.com/plugins/like.php?href=http://localhost:4000/2018-06-02-bulk-update-records-in-mysql-db-with-python&width=450&layout=standard&action=like&size=large&show_faces=true&share=true&height=80&appId=119179925551713" width="450" height="80" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowTransparency="true"></iframe>

</article>

<div class="relatedPosts">
  <h2>Related Posts</h2>
    

    <ul>
      
      
        
        
          
            <li>
              <h3>
                <a href="http://localhost:4000/2018-05-31-falling-in-love-with-python">
                  Falling in love with Python
                </a>
              </h3>
            </li>
            
            
      
        
        
          
        
      
        
        
          
        
      
        
        
          
        
      
        
        
          
        
      
        
        
          
        
          
        
      
        
        
          
        
          
        
      
    
      
      
        
          
    
          
          
            
              
              
          
        
          
    
          
          
            
          
          
            
            <li>
              <h3>
                <a href="http://localhost:4000/2018-05-28-why-being-a-devops-is-so-cool">
                  Why being a devops engineer is so cool
                  <small>28 May 2018</small>
                </a>
              </h3>
            </li>
          
        
          
    
          
          
            
          
          
            
            <li>
              <h3>
                <a href="http://localhost:4000/2018-03-02-string-matching-in-bigquery">
                  String matching in BigQuery
                  <small>02 Mar 2018</small>
                </a>
              </h3>
            </li>
          
        
          
            
      
    </ul>
</div>


  

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://localhost:4000/2018-06-02-bulk-update-records-in-mysql-db-with-python';
      this.page.identifier = 'http://localhost:4000/2018-06-02-bulk-update-records-in-mysql-db-with-python';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://sergodeeva.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



      <footer class="site-footer">
  <ul class="fa-ul">
    
      <li>
        <a href="https://github.com/sergodeeva" target="_blank">
          <i class="fa fa-github-square" aria-hidden="true"></i>
        </a>
      </li>
    
    
    <li>
      <a href="https://linkedin.com/in/natalyakosenko" target="_blank">
        <i class="fa fa-linkedin-square" aria-hidden="true"></i>
      </a>
    </li>
    
    
      <li>
        <a href="https://www.facebook.com/natalya.kosenko" target="_blank">
          <i class="fa fa-facebook-square" aria-hidden="true"></i>
         </a>
      </li>
    
    <li>
        <a href="http://eepurl.com/dgBLKn" target="_blank">
          <i class="fa fa-rss-square" aria-hidden="true"></i>
         </a>
      </li>
  </ul>
  <span class="site-footer-credits">Copyright © 2018 Natalya Kosenko</span>
</footer>
    </section>
  </body>
</html>